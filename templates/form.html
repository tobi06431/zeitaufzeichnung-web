<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Zeitaufzeichnung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

<div class="container">
  <div class="card">

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
      <h2>Zeitaufzeichnung</h2>
      <div style="text-align: right; font-size: 14px;">
        <div>üë§ {{ username }}</div>
        {% if current_user.is_admin %}
        <a href="{{ url_for('admin_dashboard') }}" style="color: #007bff; text-decoration: none; display: block; margin-top: 5px;">‚öôÔ∏è Admin</a>
        {% endif %}
        <a href="{{ url_for('account_export') }}" style="color: #28a745; text-decoration: none; display: block; margin-top: 5px;">üì• Daten exportieren</a>
        <a href="{{ url_for('account_delete') }}" style="color: #ffc107; text-decoration: none; display: block; margin-top: 5px;">üóëÔ∏è Account l√∂schen</a>
        <a href="{{ url_for('logout') }}" style="color: #dc3545; text-decoration: none; display: block; margin-top: 5px;">Abmelden</a>
      </div>
    </div>

    <!-- ‚úÖ Flash-Messages (Erfolg / Fehler) -->
    {% with messages = get_flashed_messages() %}
      {% if messages %}
        <div class="flash-wrap">
          {% for message in messages %}
            <div class="flash">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    <form method="post">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>

      <!-- ================= KIRCHENGEMEINDE ================= -->

      <div class="panel" data-panel-id="pfarrei">
        <div class="panel__header">
          <div class="panel__title">Pfarrei</div>
          <button type="button" class="panel__toggle" aria-expanded="true">‚ñº</button>
        </div>
        <div class="panel__content">

          <label>Kath. Kirchengemeinde</label>
          <select name="Kath. Kirchengemeinde" id="kirchengemeinde_input">
            <option value="{{ user_pfarrei }}" selected>{{ user_pfarrei }}</option>
          </select>
          <small style="color: #666; display: block; margin-top: 5px;">
            Automatisch auf deine Pfarrei gesetzt
          </small>

        </div>
      </div>

      <!-- ================= T√ÑTIGKEIT ================= -->

      <div class="panel" data-panel-id="taetigkeit">
        <div class="panel__header">
          <div class="panel__title">T√§tigkeit</div>
          <button type="button" class="panel__toggle" aria-expanded="true">‚ñº</button>
        </div>
        <div class="panel__content">

          <label>T√§tigkeit
            <select name="T√§tigkeit" id="taetigkeit_input">
              <option value="">-- ausw√§hlen --</option>
              <option value="Verwaltungskraft">Verwaltungskraft</option>
              <option value="Organist">Organist</option>
              <option value="Chorleiter">Chorleiter</option>
              <option value="K√ºster">K√ºster</option>
              <option value="Pflege Au√üenanlage">Pflege Au√üenanlage</option>
              <option value="Reinigung Pfarrheim">Reinigung Pfarrheim</option>
              <option value="Reinigung Kirche">Reinigung Kirche</option>
              <option value="Reinigung Pfarrb√ºro">Reinigung Pfarrb√ºro</option>
              <option value="Hausmeister">Hausmeister</option>
              <option value="Kirchenw√§sche">Kirchenw√§sche</option>
              <option value="Beerdigungsdienst">Beerdigungsdienst</option>
            </select>
          </label>

        </div>
      </div>

      <!-- ================= MONAT/JAHR ================= -->

      <div class="panel" data-panel-id="monatjahr">
        <div class="panel__header">
          <div class="panel__title">Monat/Jahr</div>
          <button type="button" class="panel__toggle" aria-expanded="true">‚ñº</button>
        </div>
        <div class="panel__content">

          <label>Monat/Jahr
            <select name="Monat/Jahr" id="monatjahr_input" required></select>
          </label>

        </div>
      </div>

      <datalist id="orte_datalist"></datalist>

      <!-- ================= ARBEITSZEITEN ================= -->

      <div class="panel" data-panel-id="arbeitszeiten">
        <div class="panel__header">
          <div class="panel__title">Arbeitszeiten</div>
          <button type="button" class="panel__toggle" aria-expanded="true">‚ñº</button>
        </div>
        <div class="panel__content">

          <label>Datum
            <input type="date" name="Arbeitszeit_Datum" id="arbeitszeit_datum">
          </label>

          <div class="grid">
            <label>Arbeitsbeginn
              <input type="time" name="Arbeitsbeginn" id="arbeitsbeginn" step="300">
            </label>

            <label>Arbeitsende
              <input type="time" name="Arbeitsende" id="arbeitsende" step="300">
            </label>
          </div>

          <div class="row" style="margin-top: 10px;">
            <button type="button" class="btn btn-secondary" onclick="addArbeitszeit()">
              Arbeitszeit hinzuf√ºgen
            </button>
          </div>

          <p class="section-hint">
            Arbeitszeiten werden lokal im Browser gespeichert ‚Äì getrennt nach Pfarrei und Monat/Jahr.
          </p>

        </div>
      </div>

      <div class="table-wrap" id="arbeitszeiten-table">
        <table>
          <thead>
            <tr>
              <th>Datum</th>
              <th>Beginn</th>
              <th>Ende</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="az_liste"></tbody>
        </table>
      </div>

      <div style="margin-top: 10px; text-align: right;">
        <button type="button" class="btn btn-danger" onclick="clearArbeitszeiten()">
          Liste leeren
        </button>
      </div>

      <input type="hidden" name="Arbeitszeiten" id="arbeitszeiten_json">

      <!-- ================= GOTTESDIENSTE ================= -->

      <div class="panel" data-panel-id="gottesdienste">
        <div class="panel__header">
          <div class="panel__title">Gottesdienste</div>
          <button type="button" class="panel__toggle" aria-expanded="true">‚ñº</button>
        </div>
        <div class="panel__content">

          <div class="gd-box">

            <div class="grid">
              <label>Kirchort
                <input type="text" id="gd_kirchort" list="orte_datalist">
              </label>

              <label>Datum
                <input type="date" id="gd_datum">
              </label>
            </div>

            <div class="grid">
              <label>Besoldungssatz
                <input
                  type="number"
                  id="gd_satz"
                  step="0.1"
                  inputmode="decimal"
                  list="satz_datalist"
                  placeholder="z.B. 1.8">
              </label>

              <label>Dienstbeginn
                <input type="time" id="gd_beginn" step="300">
              </label>
            </div>

            <div class="grid">
              <label>Dienstende
                <input type="time" id="gd_ende" step="300">
              </label>
            </div>

            <datalist id="satz_datalist">
              <option value="1.0"></option>
              <option value="1.8"></option>
              <option value="3.6"></option>
              <option value="5.2"></option>
            </datalist>

            <div class="row" style="margin-top: 10px;">
              <button type="button" class="btn btn-secondary" onclick="addGottesdienst()">
                Gottesdienst hinzuf√ºgen
              </button>
            </div>

            <p class="section-hint">
              Gottesdienste werden lokal im Browser gespeichert ‚Äì getrennt nach Pfarrei und Monat/Jahr.
            </p>
          </div>

        </div>
      </div>

      <div class="table-wrap" id="gottesdienste-table">
        <table>
          <thead>
            <tr>
              <th>Kirchort</th>
              <th>Datum</th>
              <th>Satz</th>
              <th>Beginn</th>
              <th>Ende</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="gd_liste"></tbody>
        </table>
      </div>

      <div style="margin-top: 10px; text-align: right;">
        <button type="button" class="btn btn-danger" onclick="clearGottesdienste()">
          Liste leeren
        </button>
      </div>

      <input type="hidden" name="Gottesdienste" id="gottesdienste_json">

      <hr class="sep">

      <!-- ================= PERSON ================= -->

      <div class="panel" data-panel-id="person">
        <div class="panel__header">
          <div class="panel__title">Person</div>
          <button type="button" class="panel__toggle" aria-expanded="true">‚ñº</button>
        </div>
        <div class="panel__content">

          <div class="grid">
            <label>Nachname
              <input name="Nachname" id="nachname_input">
            </label>

            <label>Vorname
              <input name="Vorname" id="vorname_input">
            </label>
          </div>

          <div class="grid">
            <label>Geburtsdatum
              <input name="Geburtsdatum" id="geburtsdatum_input">
            </label>

            <label>Pers.-Nr.
              <input name="Pers.-Nr.">
            </label>
          </div>

        </div>
      </div>

      <!-- ================= STAMMDATEN ================= -->

      <div class="panel" data-panel-id="stammdaten">
        <div class="panel__header">
          <div class="panel__title">Stammdaten</div>
          <button type="button" class="panel__toggle" aria-expanded="true">‚ñº</button>
        </div>
        <div class="panel__content">

          <div class="grid">
            <label>Einsatzort
              <input name="Einsatzort" id="einsatzort_input" list="orte_datalist">
            </label>

            <label>GKZ
              <input name="GKZ">
            </label>
          </div>

        </div>
      </div>

      <!-- ================= MEHRARBEIT ================= -->

      <div class="panel" data-panel-id="mehrarbeit">
        <div class="panel__header">
          <div class="panel__title">Mehrarbeit</div>
          <button type="button" class="panel__toggle" aria-expanded="true">‚ñº</button>
        </div>
        <div class="panel__content">

          <div class="grid">
            <label>Besch√§ftigungsumfang
              <input name="Besch√§ftigungsumfang">
            </label>

            <label>Mehrarbeit Stunden
              <input name="Mehrarbeit Stunden">
            </label>
          </div>

          <label>Mehrarbeit (Textfeld)
            <input name="Mehrarbeit (Textfeld)">
          </label>

          <label>Datum</label>
          <div class="row">
            <input id="datum" name="Datum">
            <button type="button" class="btn btn-secondary"
              onclick="document.getElementById('datum').value='{{ today }}'">
              Heute
            </button>
          </div>

          <label>Mehrarbeitsstunden auszahlen</label>
          <select name="Mehrarbeit_auszahlen">
            <option value="Nein" selected>Nein</option>
            <option value="Ja">Ja</option>
          </select>

        </div>
      </div>

      <div class="actions actions-bottom">
  <button
    type="submit"
    class="btn btn-secondary"
    formnovalidate
  >
    PDF erzeugen
  </button>

  <button
    type="submit"
    name="action"
    value="send_mail"
    class="btn btn-primary"
    formnovalidate
  >
    Daten als PDF an Verwaltung senden
  </button>
  
      <button
        type="submit"
        name="action"
        value="send_csv"
        class="btn btn-primary"
        formnovalidate
      >
        Daten als CSV an Verwaltung senden
      </button>
</div>


    </form>

  </div>
</div>

<!-- Cookie-Hinweis (DSGVO-konform) -->
<div id="cookie-banner" style="display: none; position: fixed; bottom: 0; left: 0; right: 0; background: #2c3e50; color: white; padding: 20px; text-align: center; z-index: 9999; box-shadow: 0 -2px 10px rgba(0,0,0,0.3);">
  <div style="max-width: 800px; margin: 0 auto;">
    <p style="margin: 0 0 15px 0;">
      Diese Website verwendet technisch notwendige Session-Cookies zur Authentifizierung. 
      <a href="{{ url_for('datenschutz') }}" style="color: #3498db; text-decoration: underline;" target="_blank">Mehr erfahren</a>
    </p>
    <button onclick="document.getElementById('cookie-banner').style.display='none'; localStorage.setItem('cookieAccepted', 'true');" style="background: #3498db; color: white; border: none; padding: 10px 30px; border-radius: 4px; cursor: pointer; font-size: 14px;">
      Verstanden
    </button>
  </div>
</div>

<footer style="text-align: center; padding: 20px; color: #999; font-size: 12px;">
  <a href="{{ url_for('datenschutz') }}" style="color: #999; margin: 0 10px;">Datenschutz</a> | 
  <a href="{{ url_for('impressum') }}" style="color: #999; margin: 0 10px;">Impressum</a>
</footer>

<script>
  // Cookie-Banner anzeigen, wenn nicht akzeptiert
  if (!localStorage.getItem('cookieAccepted')) {
    document.getElementById('cookie-banner').style.display = 'block';
  }
</script>

<script src="{{ url_for('static', filename='lib/storage.js') }}"></script>
<script src="{{ url_for('static', filename='lib/ui.js') }}"></script>
<script src="{{ url_for('static', filename='lib/gd.js') }}"></script>
<script src="{{ url_for('static', filename='lib/arbeitszeiten.js') }}"></script>
<script src="{{ url_for('static', filename='app.init.js') }}"></script>

</body>
</html>
